{"version":3,"file":"survey-event-receiver.js","sourceRoot":"","sources":["../../../src/utils/survey-event-receiver.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAEA,OAAO,EAAE,iBAAiB,EAAE,MAAM,cAAc,CAAA;AAGhD;IAKI,6BAAY,WAAgC;QACxC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAA;QAC9B,IAAI,CAAC,aAAa,GAAG,IAAI,GAAG,EAAoB,CAAA;IACpD,CAAC;IAED,sCAAQ,GAAR,UAAS,OAAiB;QAA1B,iBAaC;QAZG,OAAO,CAAC,OAAO,CAAC,UAAC,MAAM;;YACnB,IACI,CAAA,MAAA,MAAM,CAAC,UAAU,0CAAE,MAAM;iBACzB,MAAA,MAAA,MAAM,CAAC,UAAU,0CAAE,MAAM,0CAAE,MAAM,CAAA;gBACjC,CAAA,MAAA,MAAM,CAAC,UAAU,0CAAE,MAAM,CAAC,MAAM,CAAC,MAAM,IAAG,CAAC,EAC7C;gBACE,KAAI,CAAC,aAAa,CAAC,GAAG,CAClB,MAAM,CAAC,EAAE,EACT,MAAA,MAAM,CAAC,UAAU,0CAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,UAAC,CAAC,IAAK,OAAA,CAAC,CAAC,IAAI,EAAN,CAAM,CAAC,CACtD,CAAA;aACJ;QACL,CAAC,CAAC,CAAA;IACN,CAAC;IAED,gCAAE,GAAF,UAAG,KAAa,EAAE,YAA4B;;QAC1C,IAAM,gBAAgB,GAAa,EAAE,CAAA;QACrC,IAAM,wBAAwB,GAAa,CAAA,MAAA,IAAI,CAAC,WAAW,0CAAE,KAAK,CAAC,iBAAiB,CAAC,KAAI,EAAE,CAAA;QAE3F,IACI,mBAAmB,CAAC,uBAAuB,IAAI,KAAK;YACpD,YAAY;YACZ,wBAAwB,CAAC,MAAM,GAAG,CAAC,EACrC;YACE,iDAAiD;YACjD,IAAM,QAAQ,GAAG,MAAA,YAAY,aAAZ,YAAY,uBAAZ,YAAY,CAAE,UAAU,0CAAE,UAAU,CAAA;YACrD,IAAI,QAAQ,EAAE;gBACV,IAAM,KAAK,GAAG,wBAAwB,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAA;gBACxD,IAAI,KAAK,IAAI,CAAC,EAAE;oBACZ,wBAAwB,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAA;iBAC5C;aACJ;SACJ;aAAM;YACH,IAAI,CAAC,aAAa,CAAC,OAAO,CAAC,UAAC,MAAM,EAAE,QAAQ;gBACxC,IAAI,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;oBACxB,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAA;iBAClC;YACL,CAAC,CAAC,CAAA;SACL;QAED,IAAM,cAAc,GAAG,wBAAwB,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAA;QACxE,IAAI,CAAC,qBAAqB,CAAC,cAAc,CAAC,CAAA;IAC9C,CAAC;IAED,wCAAU,GAAV;;QACI,IAAM,wBAAwB,GAAG,MAAA,IAAI,CAAC,WAAW,0CAAE,KAAK,CAAC,iBAAiB,CAAC,CAAA;QAC3E,OAAO,wBAAwB,CAAC,CAAC,CAAC,wBAAwB,CAAC,CAAC,CAAC,EAAE,CAAA;IACnE,CAAC;IAED,8CAAgB,GAAhB;QACI,OAAO,IAAI,CAAC,aAAa,CAAA;IAC7B,CAAC;IAEO,mDAAqB,GAA7B,UAA8B,OAAiB;;;QAC3C,8CAA8C;QAC9C,MAAA,IAAI,CAAC,WAAW,0CAAE,QAAQ;YACtB,GAAC,iBAAiB,6BAAO,IAAI,GAAG,CAAC,OAAO,CAAC,SAAC;gBAC5C,CAAA;IACN,CAAC;IAjEc,2CAAuB,GAAG,cAAc,CAAA;IAkE3D,0BAAC;CAAA,AArED,IAqEC;SArEY,mBAAmB","sourcesContent":["import { Survey } from '../posthog-surveys-types'\nimport { PostHogPersistence } from '../posthog-persistence'\nimport { SURVEYS_ACTIVATED } from '../constants'\nimport { CaptureResult } from '../types'\n\nexport class SurveyEventReceiver {\n    private readonly eventRegistry: Map<string, string[]>\n    private readonly persistence?: PostHogPersistence\n    private static SURVEY_SHOWN_EVENT_NAME = 'survey shown'\n\n    constructor(persistence?: PostHogPersistence) {\n        this.persistence = persistence\n        this.eventRegistry = new Map<string, string[]>()\n    }\n\n    register(surveys: Survey[]): void {\n        surveys.forEach((survey) => {\n            if (\n                survey.conditions?.events &&\n                survey.conditions?.events?.values &&\n                survey.conditions?.events.values.length > 0\n            ) {\n                this.eventRegistry.set(\n                    survey.id,\n                    survey.conditions?.events.values.map((e) => e.name)\n                )\n            }\n        })\n    }\n\n    on(event: string, eventPayload?: CaptureResult): void {\n        const activatedSurveys: string[] = []\n        const existingActivatedSurveys: string[] = this.persistence?.props[SURVEYS_ACTIVATED] || []\n\n        if (\n            SurveyEventReceiver.SURVEY_SHOWN_EVENT_NAME == event &&\n            eventPayload &&\n            existingActivatedSurveys.length > 0\n        ) {\n            // remove survey that from activatedSurveys here.\n            const surveyId = eventPayload?.properties?.$survey_id\n            if (surveyId) {\n                const index = existingActivatedSurveys.indexOf(surveyId)\n                if (index >= 0) {\n                    existingActivatedSurveys.splice(index, 1)\n                }\n            }\n        } else {\n            this.eventRegistry.forEach((events, surveyID) => {\n                if (events.includes(event)) {\n                    activatedSurveys.push(surveyID)\n                }\n            })\n        }\n\n        const updatedSurveys = existingActivatedSurveys.concat(activatedSurveys)\n        this._saveSurveysToStorage(updatedSurveys)\n    }\n\n    getSurveys(): string[] {\n        const existingActivatedSurveys = this.persistence?.props[SURVEYS_ACTIVATED]\n        return existingActivatedSurveys ? existingActivatedSurveys : []\n    }\n\n    getEventRegistry(): Map<string, string[]> {\n        return this.eventRegistry\n    }\n\n    private _saveSurveysToStorage(surveys: string[]): void {\n        // we use a new Set here to remove duplicates.\n        this.persistence?.register({\n            [SURVEYS_ACTIVATED]: [...new Set(surveys)],\n        })\n    }\n}\n"]}